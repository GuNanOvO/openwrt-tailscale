name: Smaller Tailscale Build Pipeline

on:
  workflow_dispatch: 
  push:
    branches: [ main ]
    paths:
      - version
  repository_dispatch:
    types: [ build-tailscale ]

env:
  SOFTWARE_NAME: "Tailscale"
  FILE_NAME: "tailscaled"
  REPO: "tailscale/tailscale"
  REPO_SMALL: "GuNanOvO/openwrt-tailscale"
  REPO_SMALL_NAME: "openwrt-tailscale"
  REPO_SMALL_OWNER: "GuNanOvO"
  ARTIFACT_DIR: "artifacts"
  BUILD_DATE: ""

jobs:
  build:
    name: Build for ${{ matrix.platform.id }}
    runs-on: ubuntu-latest
    outputs: 
      upstream_commit: ${{ steps.read_commit.outputs.upstream_commit }}
      version_tag: ${{ steps.read_commit.outputs.version_tag }}
    strategy:
      matrix:
        platform:
          - id: 'aarch64_cortex-a53'
            sdk: 'aarch64_cortex-a53'
          - id: 'aarch64_cortex-a72'
            sdk: 'aarch64_cortex-a72'
          - id: 'aarch64_cortex-a76'
            sdk: 'aarch64_cortex-a76'
          - id: 'aarch64_generic'
            sdk: 'aarch64_generic'
          - id: 'arm_arm1176jzf-s_vfp'
            sdk: 'arm_arm1176jzf-s_vfp'
          - id: 'arm_arm926ej-s'
            sdk: 'arm_arm926ej-s'
          - id: 'arm_cortex-a15_neon-vfpv4'
            sdk: 'arm_cortex-a15_neon-vfpv4'
          - id: 'arm_cortex-a5_vfpv4'
            sdk: 'arm_cortex-a5_vfpv4'
          - id: 'arm_cortex-a7'
            sdk: 'arm_cortex-a7'
          - id: 'arm_cortex-a7_neon-vfpv4'
            sdk: 'arm_cortex-a7_neon-vfpv4'
          - id: 'arm_cortex-a7_vfpv4'
            sdk: 'arm_cortex-a7_vfpv4'
          - id: 'arm_cortex-a8_vfpv3'
            sdk: 'arm_cortex-a8_vfpv3'
          - id: 'arm_cortex-a9'
            sdk: 'arm_cortex-a9'
          - id: 'arm_cortex-a9_neon'
            sdk: 'arm_cortex-a9_neon'
          - id: 'arm_cortex-a9_vfpv3-d16'
            sdk: 'arm_cortex-a9_vfpv3-d16'
          - id: 'arm_fa526'
            sdk: 'arm_fa526'
          - id: 'arm_xscale'
            sdk: 'arm_xscale'
          - id: 'i386_pentium-mmx'
            sdk: 'i386_pentium-mmx'
          - id: 'i386_pentium4'
            sdk: 'i386_pentium4'
          - id: 'loongarch64_generic'
            sdk: 'loongarch64_generic'
          - id: 'mips64_mips64r2'
            sdk: 'mips64_mips64r2'
          - id: 'mips64_octeonplus'
            sdk: 'mips64_octeonplus'
          - id: 'mips64el_mips64r2'
            sdk: 'mips64el_mips64r2'
          - id: 'mips_24kc'
            sdk: 'mips_24kc'
          - id: 'mips_4kec'
            sdk: 'mips_4kec'
          - id: 'mips_mips32'
            sdk: 'mips_mips32'
          - id: 'mipsel_24kc'
            sdk: 'mipsel_24kc'
          - id: 'mipsel_24kc_24kf'
            sdk: 'mipsel_24kc_24kf'
          - id: 'mipsel_74kc'
            sdk: 'mipsel_74kc'
          - id: 'mipsel_mips32'
            sdk: 'mipsel_mips32'
          - id: 'riscv64_riscv64'
            sdk: 'riscv64_riscv64'
          - id: 'x86_64'
            sdk: 'x86_64'
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Read commit from version file
        id: read_commit
        working-directory: main
        run: |
          upstream_commit="$(grep '^UPSTREAM_COMMIT:' version | awk '{print $2}')"
          version="$(grep '^VERSION:' version | awk '{print $2}')"
          echo "upstream_commit=$upstream_commit" >> $GITHUB_OUTPUT
          echo "version_tag=$version" >>$GITHUB_OUTPUT

      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull OpenWRT SDK Docker image
        run: |
          docker pull ghcr.io/openwrt/sdk:${{ matrix.platform.sdk }}-V24.10.0

      - name: Setup UPX
        uses: crazy-max/ghaction-upx@v2
        with:
          version: latest

      - name: Prepare SDK workspace
        run: |
          mkdir -p sdk_work/openwrt/package/tailscale
          mkdir -p sdk_work/staging

      - name: Checkout packaging files
        uses: actions/checkout@v4
        with:
          path: sdk_work/openwrt/package/tailscale

      - name: Build with OpenWRT SDK Docker
        run: |
          mkdir -p "${{ env.ARTIFACT_DIR }}"
          mkdir -p sdk_work/openwrt/staging
          
          # Get UPX path
          UPX_PATH=$(which upx || echo "")
          
          docker run --rm \
            -v "$PWD/sdk_work/openwrt/package/tailscale:/home/builder/openwrt/package/tailscale:ro" \
            -v "$PWD/sdk_work/openwrt/staging:/home/builder/openwrt/staging:rw" \
            $([ -n "$UPX_PATH" ] && echo "-v $UPX_PATH:/usr/local/bin/upx:ro") \
            ghcr.io/openwrt/sdk:${{ matrix.platform.sdk }}-V24.10.0 \
            bash -c '
              set -e
              cd /home/builder/openwrt
              
              # Update feeds
              ./scripts/feeds update -a
              ./scripts/feeds install -a
              
              # Compile tailscale package
              make package/tailscale/compile V=sc JOBS=$(nproc) || true
              
              # Find and copy compiled IPK
              for ipk in bin/packages/*/tailscale_*.ipk; do
                if [ -f "$ipk" ]; then
                  cp "$ipk" /home/builder/openwrt/staging/
                  echo "Copied: $(basename $ipk)"
                fi
              done
              
              # If no IPK found, show build logs
              if [ ! -f /home/builder/openwrt/staging/*.ipk ]; then
                echo "Warning: No IPK files found in staging"
                find bin/packages -name "*.ipk" 2>/dev/null || true
                find bin/targets -name "*.ipk" 2>/dev/null || true
              fi
            '
          
          # Copy artifacts
          if [ -d "sdk_work/openwrt/staging" ] && [ -n "$(ls -A sdk_work/openwrt/staging/*.ipk 2>/dev/null)" ]; then
            cp sdk_work/openwrt/staging/*.ipk "${{ env.ARTIFACT_DIR }}/" 2>/dev/null || true
          fi

      - name: List artifacts
        run: |
          echo "Generated artifacts:"
          ls -lh "${{ env.ARTIFACT_DIR }}/" || echo "No artifacts found"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}
          path: ${{ env.ARTIFACT_DIR }}/*
          if-no-files-found: warn

  # release:
  #   name: Create Release
  #   needs: [build]
  #   runs-on: ubuntu-latest
  #   env:
  #     RELEASE_TAG: ${{ needs.build.outputs.version_tag }}
  #   steps:
  #     - name: Prepare workspace
  #       run: |
  #         mkdir -p ${{ env.ARTIFACT_DIR }}

  #     - name: Download artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: ${{ env.ARTIFACT_DIR }}
  #         merge-multiple: true

  #     - name: Generate release files
  #       run: |
  #         echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          
  #         # Since we're using SDK, just copy all IPK files
  #         cd ${{ env.ARTIFACT_DIR }}
          
  #         # Create checksums
  #         sha256sum *.ipk > checksums.txt
          
  #         # Create info file
  #         {
  #           echo "Version: ${{ env.RELEASE_TAG }}"
  #           echo "Build date: ${{ env.BUILD_DATE }}"
  #           echo ""
  #           echo "File sizes:"
  #           for file in *.ipk; do
  #             size=$(stat -c %s "${file}")
  #             echo "${file} ${size} bytes"
  #           done
  #         } > build-info.txt
  #         cd ..
          
  #         # Generate artifacts index JSON from IPK files
  #         echo "[" > ${{ env.ARTIFACT_DIR }}/artifacts.json
  #         first=true
  #         for ipk in ${{ env.ARTIFACT_DIR }}/*.ipk; do
  #           if [ -f "$ipk" ]; then
  #             filename=$(basename "$ipk")
  #             # Extract architecture from IPK filename (e.g., tailscale_1.52.0_aarch64_cortex-a72.ipk)
  #             arch=$(echo "$filename" | sed 's/.*_\([^_]*\)\.ipk$/\1/')
              
  #             if [ "$first" = true ]; then
  #               first=false
  #             else
  #               echo "," >> ${{ env.ARTIFACT_DIR }}/artifacts.json
  #             fi
  #             echo "{\"target\":\"${arch}\",\"ipk\":\"${filename}\"}" >> ${{ env.ARTIFACT_DIR }}/artifacts.json
  #           fi
  #         done
  #         echo "]" >> ${{ env.ARTIFACT_DIR }}/artifacts.json
      
  #     - name: Checkout feed branch
  #       uses: actions/checkout@v4
  #       with:
  #         ref: feed
  #         path: feed
      
  #     - name: Setup Usign
  #       run: |
  #         git clone https://git.openwrt.org/project/usign.git
  #         cd usign
  #         mkdir build
  #         cd build
  #         cmake ..
  #         make
  #         make install
          
  #     - name: Restore usign private key
  #       env:
  #         USIGN_SECRET_KEY_B64: ${{ secrets.USIGN_SECRET_KEY_B64 }}
  #       shell: bash
  #       run: |
  #         echo "$USIGN_SECRET_KEY_B64" | base64 -d > key-build.sec
  #         chmod 600 key-build.sec
          
  #     - name: Prepare feed files
  #       run: |
  #         rm -rf feed/tailscale* feed/Packages* feed/version*
                
  #         # Copy all IPK files from artifacts
  #         find ${{ env.ARTIFACT_DIR }} -name "tailscale_*.ipk" -exec cp {} feed/ \; 2>/dev/null || true

  #         # Try to generate package index if opkg-utils is available
  #         if command -v opkg-make-index &> /dev/null; then
  #           cd feed
  #           opkg-make-index -a -f -v --checksum sha256 . > Packages 2>&1 || echo "Failed to generate package index, continuing..."
  #           gzip -kf Packages
  #           cd ..
  #         else
  #           echo "opkg-utils not available, skipping package index generation"
  #         fi
              
  #         ls -lh feed/ || true
          
  #         [ -f feed/Packages ] && file feed/Packages || true
  #         [ -f key-build.sec ] && file key-build.sec || true

  #         if [ -f feed/Packages ] && [ -f key-build.sec ]; then
  #           usign -S -m feed/Packages -s key-build.sec -x feed/Packages.sig || echo "Signing failed, continuing..."
  #           [ -f feed/Packages.sig ] && cat feed/Packages.sig || true
  #         fi
          
  #         generate_tbody() {
  #           echo "          <tbody>"
  #           for file in feed/Packages* feed/tailscale*; do
  #             [ -f "${file}" ] || continue
  #             fname=$(basename "${file}")
  #             fsize=$(du -h "${file}" | cut -f1)
  #             fdate=$(date -r "${file}" +"%Y-%m-%d %a %H:%M:%S UTC")
  #             echo "                        <tr>"
  #             echo "                            <td><a href=\"$fname\">$fname</a></td>"
  #             echo "                            <td>$fsize</td>"
  #             echo "                            <td>$fdate</td>"
  #             echo "                        </tr>"
  #           done
  #           echo "          </tbody>"
  #         }

  #         generate_tbody > feed/tbody.tmp
  #         sed -i '/<!-- tbody-anchor -->/,/<!-- end-tbody-anchor -->/ {
  #           /<!-- tbody-anchor -->/!{
  #             /<!-- end-tbody-anchor -->/!d
  #           }
  #         }' feed/index.html
  #         sed -i '/<!-- tbody-anchor -->/r feed/tbody.tmp' feed/index.html

  #         current_date="${{ env.BUILD_DATE }}"
  #         sed -i '/<!-- date-anchor -->/,/<!-- end-date-anchor -->/ {
  #             /<span id="date">/ {
  #                 s#<span id="date">.*</span>#<span id="date">'"${current_date}"'</span>#
  #             }
  #         }' feed/index.html

  #         version=$(echo "${{ env.RELEASE_TAG }}" | sed 's/^v//')
  #         sed -i '/<!-- version-anchor -->/,/<!-- end-version-anchor -->/ {
  #             /<span id="version">/ {
  #                 s#<span id="version">.*</span>#<span id="version">'"${version}"'</span>#
  #             }
  #         }' feed/index.html
  #         rm -f feed/tbody.tmp

  #     - name: Commit and push to feed branch
  #       run: |
  #         git config --local user.email "action@github.com"
  #         git config --local user.name "GitHub Action"
  #         git add -A
  #         git diff --cached --quiet && echo "No changes" && exit 0
  #         git commit -m "Update feed: ${{ env.BUILD_DATE }}"
  #         git push origin HEAD:feed
  #       working-directory: feed

  #     - name: Generate release markdown
  #       id: generate_release_markdown
  #       run: |
  #         # Read artifacts.json and generate markdown table
  #         artifacts_file="${{ env.ARTIFACT_DIR }}/artifacts.json"
          
  #         if [[ ! -f "${artifacts_file}" ]]; then
  #           echo "No artifacts.json found, skipping table generation."
  #           exit 1
  #         fi
          
  #         # Generate Markdown table for IPK files only
  #         owner="${{ env.REPO_SMALL_OWNER }}"
  #         repo="${{ env.REPO_SMALL_NAME }}"
  #         tag="${{ env.RELEASE_TAG }}"
  #         table="| Target Platform ç›®æ ‡å¹³å° | IPK Package |
  #         |----------------------|------------|
  #         $(jq -r --arg owner "$owner" --arg repo "$repo" --arg tag "$tag" '
  #         .[] | 
  #         "| \(.target) | [\(.ipk)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.ipk)) |"
  #         ' ${artifacts_file})"

  #         # Print the table for debugging
  #         echo "$table"

  #         # Set release body with table included
  #         release_body="## ğŸš€ Smaller Tailscale / æ›´å°çš„Tailscale

  #         **Version ç‰ˆæœ¬** :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${{ env.RELEASE_TAG }}   
  #         **Build date æ„å»ºæ—¥æœŸ** : &nbsp;&nbsp;&nbsp;&nbsp;${{ env.BUILD_DATE }}   
  #         **Changelog æ›´æ–°æ—¥å¿—** : &nbsp;&nbsp;&nbsp;https://github.com/${{ env.REPO }}/releases/tag/${{ env.RELEASE_TAG }}   

  #         ---

  #         ### ğŸŒ ä¸­æ–‡è¯´æ˜
  #         <details>
  #         <summary>ç‚¹å‡»å±•å¼€</summary>
  #         è¿™æ˜¯ä¸€ä¸ªä¸º OpenWRT æ„å»ºçš„ Tailscale çš„æç®€ç‰ˆæœ¬ï¼Œä½¿ç”¨ OpenWRT å®˜æ–¹ SDK ç¼–è¯‘ï¼Œæ—¨åœ¨æä¾›æ›´å°çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ›´å°‘çš„èµ„æºå ç”¨ã€‚åŒ…å« IPK åŒ…ï¼Œé€‚ç”¨äºå¤šç§ OpenWRT ç›®æ ‡å¹³å°ã€‚

  #         ### ğŸ› ï¸ æ„å»ºç‰¹æ€§
  #         - ä½¿ç”¨ OpenWRT å®˜æ–¹ SDK è¿›è¡Œç¼–è¯‘
  #         - Tailscale ä½¿ç”¨ç²¾ç®€çš„ TAGS ä¸ LDFLAGS ç¼–è¯‘
  #         - ä½¿ç”¨ UPX å‹ç¼©æŠ€æœ¯å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼ˆæŸäº›æ¶æ„é™¤å¤–ï¼‰ï¼Œå¤§å¹…å‡å° IPK ä½“ç§¯
  #         - å®Œæ•´çš„ IPK åŒ…æ ¼å¼ï¼Œå¯ç›´æ¥é€šè¿‡ opkg å®‰è£…

  #         ### âš ï¸ ç³»ç»Ÿéœ€æ±‚
  #         - **å­˜å‚¨ç©ºé—´**: IPK æ–‡ä»¶é€šå¸¸å°äº 10MB
  #         - **è¿è¡Œå†…å­˜**: å¤§çº¦ 60MB
  #         - **æ³¨æ„äº‹é¡¹**: å¯èƒ½æ— æ³•åœ¨å†…å­˜å°äº 256MB çš„è®¾å¤‡ä¸Šæ­£å¸¸è¿è¡Œï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚

  #         ### ğŸ“– å¦‚ä½•ç¡®å®šç›®æ ‡å¹³å°
  #         åœ¨æ‚¨çš„ OpenWRT è®¾å¤‡ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥ç¡®å®šæ”¯æŒçš„ç›®æ ‡å¹³å°ï¼š
  #         \`\`\`bash
  #         opkg print-architecture
  #         \`\`\`
  #         è¯¥å‘½ä»¤å°†åˆ—å‡ºè®¾å¤‡æ”¯æŒçš„æ¶æ„ç±»å‹ï¼ˆä¸åŒ…æ‹¬ \`all\` å’Œ \`noarch\`ï¼‰ã€‚æ ¹æ®è¾“å‡ºç»“æœé€‰æ‹©å¯¹åº”çš„æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚

  #         ### ğŸ“¦ å®‰è£…æ–¹æ³•
  #         \`\`\`bash
  #         opkg install tailscale_X.XX.X_<your_architecture>.ipk
  #         \`\`\`

  #         </details>

  #         ### ğŸŒ English Description
  #         <details>
  #         <summary>Click to expand</summary>
  #         This is a minimal build of Tailscale for OpenWRT, compiled using the official OpenWRT SDK, designed to provide smaller binaries and lower resource usage. It includes IPK packages for various OpenWRT target platforms.

  #         ### ğŸ› ï¸ Build Features
  #         - Compiled using the official OpenWRT SDK
  #         - Tailscale uses streamlined TAGS and LDFLAGS for compilation
  #         - UPX compression applied to binaries (except for some architectures) to significantly reduce IPK size
  #         - Complete IPK package format, can be installed directly via opkg

  #         ### âš ï¸ System Requirements
  #         - **Storage Space**: IPK files are typically less than 10MB
  #         - **RAM**: Approximately 60MB
  #         - **Note**: May not work on devices with less than 256MB of RAM. Use with caution.

  #         ### ğŸ“– How to Determine the Target Platform
  #         Run the following command on your OpenWRT device to determine the supported target platform:
  #         \`\`\`bash
  #         opkg print-architecture
  #         \`\`\`
  #         This command will list the supported architecture types (excluding \`all\` and \`noarch\`). Choose the corresponding file based on the output.

  #         ### ğŸ“¦ Installation Method
  #         \`\`\`bash
  #         opkg install tailscale_X.XX.X_<your_architecture>.ipk
  #         \`\`\`

  #         </details>

  #         ---

  #         > [!WARNING]
  #         > å¦‚æœ \`opkg\` å®‰è£…æ˜¾ç¤ºå®‰è£…å¤±è´¥ï¼Œè¯·å…ˆé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æµ‹è¯•ï¼š
  #         > \`\`\`bash
  #         > tailscale --version
  #         > \`\`\`
  #         > å¦‚æœå‘½ä»¤æ­£ç¡®è¾“å‡ºç‰ˆæœ¬å·ï¼Œåˆ™å®‰è£…æˆåŠŸã€‚å¦åˆ™è¯·æäº¤åé¦ˆã€‚
  #         >
  #         > If the \`opkg\` installation shows failure, please test first by running:
  #         > \`\`\`bash
  #         > tailscale --version
  #         > \`\`\`
  #         > If the command correctly outputs the version number, the installation is successful. Otherwise, please submit feedback.

  #         ---

  #         ### ğŸ“¥ Download Links List / ä¸‹è½½é“¾æ¥æ¸…å•
  #         > [!NOTE]
  #         > è¯·ç¡®ä¿é€‰æ‹©æ­£ç¡®çš„ç›®æ ‡å¹³å°æ¶æ„å’Œ Tailscale ç‰ˆæœ¬ã€‚
  #         > Make sure to select the correct target platform architecture and Tailscale version.
  #         <details>
  #         <summary>Click to expand  /  ç‚¹å‡»å±•å¼€</summary>

  #         ${table}

  #         </details>
  #         "

  #         echo "release_body<<EOF" >> $GITHUB_OUTPUT
  #         echo "${release_body}" >> $GITHUB_OUTPUT
  #         echo "EOF" >> $GITHUB_OUTPUT

  #     - name: Create GitHub Release
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         tag_name: ${{ env.RELEASE_TAG }}
  #         name: "Smaller ${{ env.SOFTWARE_NAME }} ${{ env.RELEASE_TAG }}"
  #         body: ${{ steps.generate_release_markdown.outputs.release_body }}
  #         files: |
  #           ${{ env.ARTIFACT_DIR }}/*.ipk
  #           ${{ env.ARTIFACT_DIR }}/checksums.txt
  #           ${{ env.ARTIFACT_DIR }}/build-info.txt


  #     - name: Sync to small repo
  #       uses: actions/github-script@v6
  #       with:
  #         script: |
  #           await github.rest.git.createTag({
  #             owner: '${{ env.REPO_SMALL_OWNER }}',
  #             repo: 'openwrt-tailscale',
  #             tag: '${{ env.RELEASE_TAG }}',
  #             message: 'Release ${{ env.RELEASE_TAG }}',
  #             object: '${{ github.sha }}',
  #             type: 'commit'
  #           })