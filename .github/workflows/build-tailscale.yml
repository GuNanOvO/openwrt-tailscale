name: Smaller Tailscale Build Pipeline

on:
  workflow_dispatch: 
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: ghcr.io/openwrt/sdk:${{ matrix.id }}-V24.10.4
    strategy:
      matrix:
        include:
          - id: 'aarch64_cortex-a53'
          - id: 'mips_24kc'

    steps:
      - name: Initialize SDK Environment
        run: |
          cp -r /builder/. .
          
          ./scripts/feeds update packages
          ./scripts/feeds install golang tailscale
          make defconfig

      - name: Extract Go Variables
        run: |
          # 动态提取 SDK 为当前架构计算出的 Go 参数
          cat << 'EOF' > get_go_vars.mk
          include rules.mk
          include feeds/packages/lang/golang/golang-package.mk
          show_go_vars:
          	@echo "GOARCH=$(GO_ARCH)"
          	@echo "GOARM=$(GO_ARM)"
          	@echo "GOMIPS=$(GO_MIPS)"
          	@echo "GOMIPS64=$(GO_MIPS64)"
          	@echo "GO386=$(GO_386)"
          EOF
          make -s -f get_go_vars.mk show_go_vars >> $GITHUB_ENV

      - name: Fast Go Build
        run: |
          git clone https://github.com/tailscale/tailscale --depth 1
          cd tailscale
          # 使用提取的环境变量进行编译
          GOOS=linux \
          GOARCH=${{ env.GOARCH }} \
          GOARM=${{ env.GOARM }} \
          GOMIPS=${{ env.GOMIPS }} \
          GOMIPS64=${{ env.GOMIPS64 }} \
          CGO_ENABLED=0 \
          go build -v -trimpath -ldflags="-s -w" -o ../tailscaled ./cmd/tailscaled

      - name: Inject Binary and Package IPK
        run: |
          # 定位包路径（在 feeds 安装后）
          PKG_PATH="package/feeds/packages/tailscale"
          
          # 获取构建目录
          PKG_BUILD_DIR=$(make -C $PKG_PATH -V PKG_BUILD_DIR)
          BIN_DIR=$(make -C $PKG_PATH -V GO_PKG_BUILD_BIN_DIR)
          
          # 注入预编译二进制
          mkdir -p $BIN_DIR
          cp ./tailscaled $BIN_DIR/
          mkdir -p $PKG_BUILD_DIR
          touch $PKG_BUILD_DIR/.built
          
          # 只执行打包逻辑
          make $PKG_PATH/compile V=s

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-${{ matrix.id }}
          path: bin/targets/*/*/packages/tailscale*.ipk