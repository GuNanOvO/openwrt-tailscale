name: Smaller Tailscale Build Pipeline

on:
  workflow_dispatch: 
  push:
    branches: [ main ]
    paths:
      - version
  repository_dispatch:
    types: [ build-tailscale ]

env:
  SOFTWARE_NAME: "Tailscale"
  FILE_NAME: "tailscaled"
  REPO: "tailscale/tailscale"
  REPO_SMALL: "GuNanOvO/openwrt-tailscale"
  REPO_SMALL_NAME: "openwrt-tailscale"
  REPO_SMALL_OWNER: "GuNanOvO"
  ARTIFACT_DIR: "artifacts"
  BUILD_DATE: ""

jobs:
  build:
    runs-on: ubuntu-latest
    container: ghcr.io/openwrt/sdk:${{ matrix.id }}
    strategy:
      matrix:
        include:
          - id: 'aarch64_cortex-a53'
          - id: 'mips_24kc'

    steps:
      - name: Prepare SDK and Feeds
        run: |
          [ ! -d ./scripts ] && ./setup.sh
          ./scripts/feeds update packages
          make defconfig
          ./scripts/feeds install golang tailscale

      - name: Extract Go Variables
        run: |
          cat << 'EOF' > get_go_vars.mk
          include rules.mk
          include feeds/packages/lang/golang/golang-package.mk
          show_go_vars:
          	@echo "GOARCH=$(GO_ARCH)" >> $(GITHUB_ENV)
          	@echo "GOARM=$(GO_ARM)" >> $(GITHUB_ENV)
          	@echo "GOMIPS=$(GO_MIPS)" >> $(GITHUB_ENV)
          	@echo "GOMIPS64=$(GO_MIPS64)" >> $(GITHUB_ENV)
          	@echo "GO386=$(GO_386)" >> $(GITHUB_ENV)
          EOF
          # 必须执行一次这个来导出变量到 GitHub 环境
          make -f get_go_vars.mk show_go_vars

      - name: Fast Go Build (Outside SDK Logic)
        run: |
          # 克隆代码并直接用 Go 编译，利用上一步提取的参数
          git clone https://github.com/tailscale/tailscale --depth 1
          cd tailscale
          GOOS=linux GOARCH=${{ env.GOARCH }} GOARM=${{ env.GOARM }} \
          GOMIPS=${{ env.GOMIPS }} GOMIPS64=${{ env.GOMIPS64 }} \
          CGO_ENABLED=0 \
          go build -v -ldflags="-s -w" -o ../tailscaled ./cmd/tailscaled

      - name: Inject Binary and Package IPK
        run: |
          # 1. 获取 SDK 为该包准备的构建目录
          PKG_BUILD_DIR=$(make -C feeds/packages/net/tailscale -V PKG_BUILD_DIR)
          BIN_DIR=$(make -C feeds/packages/net/tailscale -V GO_PKG_BUILD_BIN_DIR)
          
          # 2. 注入二进制并标记已编译
          mkdir -p $BIN_DIR
          cp ./tailscaled $BIN_DIR/
          mkdir -p $PKG_BUILD_DIR
          touch $PKG_BUILD_DIR/.built
          
          # 3. 仅打包 (极其快速，因为跳过了编译)
          make package/feeds/packages/tailscale/install V=s
          
          # 4. 收集产物
          mkdir -p ./artifact
          find bin/targets -name "tailscale*.ipk" -exec cp {} ./artifact/ \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-${{ matrix.id }}
          path: ./artifact/