name: Smaller Tailscale Build Pipeline

on:
  schedule:
    - cron: '30 0/12 * * *'
  workflow_dispatch:

env:
  SOFTWARE_NAME: "Tailscale"
  FILE_NAME: "tailscaled"
  REPO: "tailscale/tailscale"
  REPO_SMALL: "GuNanOvO/openwrt-tailscale"
  REPO_SMALL_NAME: "openwrt-tailscale"
  REPO_SMALL_OWNER: "GuNanOvO"
  ARTIFACT_DIR: "artifacts"
  BUILD_DATE: ""
jobs:
  version-check:
    name: Check Version Differences
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      upstream_tag: ${{ steps.get_upstream.outputs.tag }}
    steps:
      - name: Get latest stable tag from tailscale
        id: get_upstream
        uses: actions/github-script@v6
        with:
          script: |
            const { data: tags } = await github.rest.repos.listTags({
              owner: 'tailscale',
              repo: 'tailscale',
              per_page: 100
            });

            const stableTags = tags
              .map(tag => tag.name)
              .filter(name => /^v\d+\.\d+\.\d+$/.test(name));

            stableTags.sort((a, b) => {
              const parse = v => v.slice(1).split('.').map(Number);
              const [a1, a2, a3] = parse(a);
              const [b1, b2, b3] = parse(b);
              return b1 - a1 || b2 - a2 || b3 - a3;
            });

            const latest = stableTags[0] || '';
            core.setOutput('tag', latest);

      - name: Get latest release tag from openwrt-tailscale
        id: get_small
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const { data } = await github.rest.repos.getLatestRelease({
                owner: 'GuNanOvO',
                repo: 'openwrt-tailscale'
              });
              core.setOutput('tag', data?.tag_name || '');
            } catch (error) {
              core.setOutput('tag', '');
            }

      - name: Compare versions
        id: compare
        run: |
          echo "Upstream: ${{ steps.get_upstream.outputs.tag }}"
          echo "Local: ${{ steps.get_small.outputs.tag }}"
          if [ "${{ steps.get_upstream.outputs.tag }}" != "${{ steps.get_small.outputs.tag }}" ]; then
            echo "should_build=true" >> ${GITHUB_OUTPUT}
          else
            echo "should_build=false" >> ${GITHUB_OUTPUT}
          fi

  build:
    name: Build for ${{ matrix.platform.id }}
    needs: version-check
    if: needs.version-check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [
          {
            id: 'arm',
            goarch: 'arm',
            openwrt_targets: 
              [
              'arm_arm1176jzf-s_vfp',
              'arm_arm926ej-s',
              'arm_cortex-a15_neon-vfpv4',
              'arm_cortex-a5_vfpv4',
              'arm_cortex-a7',
              'arm_cortex-a7_neon-vfpv4',
              'arm_cortex-a7_vfpv4',
              'arm_cortex-a8_vfpv3',
              'arm_cortex-a9',
              'arm_cortex-a9_neon',
              'arm_cortex-a9_vfpv3-d16',
              'arm_fa526',
              'arm_xscale',
              'arm_mpcore'
            ]
          },
          {
            id: 'arm64',
            goarch: 'arm64',
            openwrt_targets: [
              'aarch64_cortex-a53',
              'aarch64_cortex-a72',
              'aarch64_cortex-a76',
              'aarch64_generic'
            ]
          },
          {
            id: 'mips',
            goarch: 'mips',
            gomips: 'softfloat',
            openwrt_targets: [
              'mips_24kc',
              'mips_4kec',
              'mips_mips32'
            ]
          },
          {
            id: 'mipsle',
            goarch: 'mipsle',
            gomips: 'softfloat',
            openwrt_targets: [
              'mipsel_24kc',
              'mipsel_24kc_24kf',
              'mipsel_74kc',
              'mipsel_mips32'
            ]
          },
          {
            id: 'mips64',
            goarch: 'mips64',
            gomips: 'softfloat',
            openwrt_targets: [
              'mips64_mips64r2',
              'mips64_octeonplus'
            ]
          },
          {
            id: 'mips64le',
            goarch: 'mips64le',
            gomips: 'softfloat',
            openwrt_targets: [
              'mips64el_mips64r2'
            ]
          },
          {
            id: '386',
            goarch: '386',
            openwrt_targets: [
              'i386_pentium-mmx',
              'i386_pentium4'
            ]
          },
          {
            id: 'amd64',
            goarch: 'amd64',
            cgo_enabled: '1',
            cc: 'musl-gcc',
            setup: 'sudo apt-get update && sudo apt-get install -y musl-tools',
            openwrt_targets: [
              'x86_64'
            ]
          },
          {
            id: 'geode',
            goarch: '386',
            go386: 'softfloat',
            openwrt_targets: [
              'i386_pentium-mmx',
              'i386_pentium4'
            ]
          }
        ]

      fail-fast: false

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO }}
          ref: ${{ needs.version-check.outputs.upstream_tag }}
          path: src

      - name: Checkout packaging files
        uses: actions/checkout@v4
        with:
          path: packaging

      - name: Setup build environment
        run: |
          ${{ matrix.platform.setup || 'echo "No additional setup required"' }}
          
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true
          cache-dependency-path: src/go.sum

      - name: Setup UPX
        uses: crazy-max/ghaction-upx@v2
        with:
          version: latest

      - name: Build binary
        working-directory: ./src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.platform.goarch }}
          GOMIPS: ${{ matrix.platform.gomips || '' }}
          GO386: ${{ matrix.platform.go386 || '' }}
          CGO_ENABLED: ${{ matrix.platform.cgo_enabled || 0 }}
          CC: ${{ matrix.platform.cc || '' }}
        run: |
          output_name="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}"
          mkdir -p ../build
          ./build_dist.sh \
            --extra-small --box \
            -o "../build/${output_name}" \
            ./cmd/${{ env.FILE_NAME }}
          
          # Verify the binary was created
          if [ ! -f "../build/${output_name}" ]; then
            echo "::error::Build failed for ${{ matrix.platform.id }}"
            exit 1
          fi

      - name: Process binary
        run: |
          # Process binary
          mkdir -p compressed "${{ env.ARTIFACT_DIR }}"
          filename="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}"
          file="build/${filename}"
          chmod -v +x "${file}"
          # Create uncompressed copy
          cp -p "${file}" "compressed/${filename}-normal"
          cp -p "${file}" "${{ env.ARTIFACT_DIR }}/${filename}-normal"
          # Skip unsupported platforms
          if [[ "${filename}" =~ (mips64|mips64le) ]]; then
            echo "Skipping UPX for ${filename}"
          else
            # Compress with UPX
            upx --lzma --best --no-progress "${file}" -o "compressed/${filename}"
            cp -p "compressed/${filename}" "${{ env.ARTIFACT_DIR }}/${filename}"
          fi

      - name: Package IPK
        run: |
          EPOCH=$(date +%s)
          mkdir -p ipk/usr/bin ipk/etc ipk/lib ipk/CONTROL
          for bin in compressed/${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}*; do
            basebin=$(basename "${bin}")

            if [[ "${basebin}" =~ -normal$ ]]; then
              normal_bin="${basebin}"
            else
              compressed_bin="${basebin}"
            fi

            install -m 0755 "${bin}" ipk/usr/bin/tailscaled
            ln -svf tailscaled ipk/usr/bin/tailscale || true
            SIZE=$(du -sb ipk/usr/bin | awk '{print $1}')

            cp -a packaging/etc/* ipk/etc/
            cp -a packaging/lib/* ipk/lib/
            cp -a packaging/CONTROL/* ipk/CONTROL/

            chmod +x ipk/etc/init.d/tailscale || true
            echo '2.0' > ipk/debian-binary

            targets_json='${{ toJson(matrix.platform.openwrt_targets) }}'
            targets=$(echo "${targets_json}" | jq -r '.[]')

            for target in ${targets}; do
              ARCH=${target}
              VERSION=$(echo "${{ needs.version-check.outputs.upstream_tag }}" | sed 's/^v//')

              if [[ -z "$compressed_bin" ]]; then
                ipk_compressed="tailscale_${VERSION}_${ARCH}_normal.ipk"
              else
                ipk_compressed="tailscale_${VERSION}_${ARCH}.ipk"
              fi
              ipk_normal="tailscale_${VERSION}_${ARCH}_normal.ipk"

              sed -e "s/__VERSION__/${VERSION}/" \
                  -e "s/__ARCH__/${ARCH}/" \
                  -e "s/__SIZE__/${SIZE}/" \
                  -e "s/__EPOCH__/${EPOCH}/" \
                  packaging/CONTROL/control > ipk/CONTROL/control

              VERSION=${{ needs.version-check.outputs.upstream_tag }}
              tar --format=ustar -C ipk/CONTROL -czf control.tar.gz .
              tar --format=ustar -C ipk -czf data.tar.gz ./usr ./etc ./lib
              if [[ "${bin}" =~ (normal) ]]; then
                ar r ${{ env.ARTIFACT_DIR }}/tailscale_${VERSION}_${ARCH}_normal.ipk control.tar.gz data.tar.gz ipk/debian-binary
                echo "Created IPK: tailscale_${VERSION}_${ARCH}_normal.ipk"
              else
                ar r ${{ env.ARTIFACT_DIR }}/tailscale_${VERSION}_${ARCH}.ipk control.tar.gz data.tar.gz ipk/debian-binary
                echo "Created IPK: tailscale_${VERSION}_${ARCH}.ipk"
              fi

              rm -f control.tar.gz data.tar.gz

            done
            rm -f ipk/usr/bin/*

          done
          
          targets_json='${{ toJson(matrix.platform.openwrt_targets) }}'
          targets=$(echo "${targets_json}" | jq -r '.[]')

          : > ${{ env.ARTIFACT_DIR }}/artifacts.json.tmp

          for target in ${targets}; do
            ARCH=${target}
            VERSION=${{ needs.version-check.outputs.upstream_tag }}

            if [[ "${{ matrix.platform.id }}" =~ ^mips64 ]]; then
              binary_compressed="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}-normal"
              ipk_compressed="tailscale_${VERSION}_${ARCH}_normal.ipk"
              elif [[ "${{ matrix.platform.id }}" =~ ^mips64le ]]; then
              binary_compressed="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}-normal"
              ipk_compressed="tailscale_${VERSION}_${ARCH}_normal.ipk"
              else
              binary_compressed="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}"
              ipk_compressed="tailscale_${VERSION}_${ARCH}.ipk"
            fi

            binary_normal="${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}-normal"
            ipk_normal="tailscale_${VERSION}_${ARCH}_normal.ipk"

            [ -f "${{ env.ARTIFACT_DIR }}/${binary_compressed}" ] || binary_compressed=""
            [ -f "${{ env.ARTIFACT_DIR }}/${binary_normal}" ] || binary_normal=""
            [ -f "${{ env.ARTIFACT_DIR }}/${ipk_compressed}" ] || ipk_compressed=""
            [ -f "${{ env.ARTIFACT_DIR }}/${ipk_normal}" ] || ipk_normal=""

            echo "{\"target\":\"${ARCH}\",\"binary_compressed\":\"${binary_compressed}\",\"binary_normal\":\"${binary_normal}\",\"ipk_compressed\":\"${ipk_compressed}\",\"ipk_normal\":\"${ipk_normal}\"}," >> ${{ env.ARTIFACT_DIR }}/artifacts.json.tmp
          done

          {
            echo "["
            sed '$ s/,$//' ${{ env.ARTIFACT_DIR }}/artifacts.json.tmp
            echo "]"
          } > ${{ env.ARTIFACT_DIR }}/artifacts-${{ matrix.platform.id }}.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FILE_NAME }}-linux-${{ matrix.platform.id }}
          path: ${{ env.ARTIFACT_DIR }}/*

  release:
    name: Create Release
    needs: [version-check, build]
    if: needs.version-check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ needs.version-check.outputs.upstream_tag }}
    steps:
      - name: Prepare workspace
        run: |
          mkdir -p ${{ env.ARTIFACT_DIR }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.ARTIFACT_DIR }}
          merge-multiple: true

      - name: Generate release files
        run: |
          echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
          jq -s 'add' ${{ env.ARTIFACT_DIR }}/artifacts-*.json > ${{ env.ARTIFACT_DIR }}/artifacts.json
          rm -rf ${{ env.ARTIFACT_DIR }}/artifacts-*.json
          rm -rf ${{ env.ARTIFACT_DIR }}/artifacts.json.tmp
          # Create checksums
          cd ${{ env.ARTIFACT_DIR }}
          sha256sum * > checksums.txt
          
          # Create info file
          {
            echo "Version: ${{ env.RELEASE_TAG }}"
            echo "Build date: ${{ env.BUILD_DATE }}"
            echo ""
            echo "File sizes:"
            for file in ${{ env.FILE_NAME }}-*; do
              size=$(stat -c %s "${file}")
              echo "${file} ${size} bytes"
            done
          } > build-info.txt
          cd ..

      - name: Generate release markdown
        id: generate_release_markdown
        run: |
          # Read artifacts.json and generate markdown table
          artifacts_file="${{ env.ARTIFACT_DIR }}/artifacts.json"
          
          if [[ ! -f "${artifacts_file}" ]]; then
            echo "No artifacts.json found, skipping table generation."
            exit 1
          fi
          
          # Generate Markdown table
          owner="${{ env.REPO_SMALL_OWNER }}"
          repo="${{ env.REPO_SMALL_NAME }}"
          tag="${{ env.RELEASE_TAG }}"
            table="| Target Platform 目标平台 | Compressed Binary 压缩二进制 | Compressed IPK 压缩IPK | Normal Binary 原始二进制 | Normal IPK 原始IPK |
            |----------------------|-------------------------|------------------------|---------------------|----------------|
            $(jq -r --arg owner "$owner" --arg repo "$repo" --arg tag "$tag" '
            .[] | 
            "| \(.target) | " +
            (if .binary_compressed != "" then "[\(.binary_compressed)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.binary_compressed))" else "" end) + " | " +
            (if .ipk_compressed != "" then "[\(.ipk_compressed)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.ipk_compressed))" else "" end) + " | " +
            (if .binary_normal != "" then "[\(.binary_normal)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.binary_normal))" else "" end) + " | " +
            (if .ipk_normal != "" then "[\(.ipk_normal)](https://github.com/\($owner)/\($repo)/releases/download/\($tag)/\(.ipk_normal))" else "" end) + " |"
            ' ${artifacts_file})"

          # Print the table for debugging
          echo "$table"

          # Set release body with table included
          release_body="## 🚀 Smaller Tailscale / 更小的Tailscale

          **Version 版本** :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${{ env.RELEASE_TAG }}   
          **Build date 构建日期** : &nbsp;&nbsp;&nbsp;&nbsp;${{ env.BUILD_DATE }}   
          **Changelog 更新日志** : &nbsp;&nbsp;&nbsp;https://github.com/${{ env.REPO }}/releases/tag/${{ env.RELEASE_TAG }}   

          ---

          ### 🛠️ Build Features / 构建特性
          - Combined \`tailscale\` & \`tailscaled\` into single binary / 合并为单一二进制文件  
          - Built with \`--extra-small\` flag / 极简编译选项  
          - UPX compressed (except mips64) / UPX 压缩 (mips64除外)  
          ### ⚠️ Requirements / 需求说明
          - **Storage/存储空间**: <10MB (UPX)  
          - **RAM/运行内存**: ~60MB  
          - **Warning/警告**: May not work on devices with <256MB RAM / 内存小于256MB的设备可能无法运行  
          ### 📦 About -normal version / 未压缩版本说明
          - \`filename-normal\`: Original binary / 原始二进制  
          - \`filename\`: UPX compressed / UPX压缩版本  
          ### 📖 How to Determine the Target Platform / 如何确定目标平台
          Run the following command on your OpenWRT device / 在您的OpenWRT设备上运行以下命令:
          \`\`\`bash
          opkg print-architecture
          \`\`\`
          This will list supported architectures, excluding \`all\` and \`noarch\` / 这将列出支持的架构，排除\`all\`和\`noarch\`

          ---

          ### 📥 Download Links / 下载链接
          ${table}"

          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "${release_body}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Smaller ${{ env.SOFTWARE_NAME }} ${{ env.RELEASE_TAG }}"
          body: ${{ steps.generate_release_markdown.outputs.release_body }}
          files: |
            ${{ env.ARTIFACT_DIR }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Sync to small repo
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.git.createTag({
              owner: 'GuNanOvO',
              repo: 'openwrt-tailscale',
              tag: '${{ env.RELEASE_TAG }}',
              message: 'Release ${{ env.RELEASE_TAG }}',
              object: '${{ github.sha }}',
              type: 'commit'
            })